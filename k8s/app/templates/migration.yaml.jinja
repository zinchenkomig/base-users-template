apiVersion: batch/v1
kind: Job
metadata:
  name: db-migration
  annotations:
    "helm.sh/hook": pre-install,pre-upgrade
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
spec:
  template:
    spec:
      imagePullSecrets:
        - name: yr-key
      containers:
      - name: migration 
        image: {{image_name}}:latest
        envFrom:
          - secretRef:
              name: secretkv
        env:
        - name: {{env_prefix}}_DB_ADDRESS
          value: postgres-svc
        - name: JAEGER_BACKEND
          value: jaeger-svc-collector:4317
        - name: {{env_prefix}}_DB_NAME
          value: svc-db
        - name: {{env_prefix}}_DB_USER
          value: service-user
        - name: {{env_prefix}}_DB_PASSWORD
          valueFrom:
            secretKeyRef:
              name: postgres-svc
              key: password
        command: ["alembic", "upgrade", "head"]  # Run Alembic migration
      restartPolicy: Never

